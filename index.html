<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life360 - Pelacak Lokasi Keluarga</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            font-family: 'Roboto Slab', serif;
        }
        
        :root {
            --primary-color: #8CA9FF;
            --primary-dark: #6B8EE8;
            --bg-color: #f8f9fa;
        }
        
        body {
            background-color: var(--bg-color);
            overflow-x: hidden;
        }
        
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        }
        
        .auth-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 450px;
            width: 90%;
            margin: 20px;
        }
        
        .auth-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .auth-logo i {
            font-size: 60px;
            color: var(--primary-color);
        }
        
        .auth-logo h2 {
            color: var(--primary-dark);
            margin-top: 15px;
            font-weight: 700;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            padding: 12px;
            font-weight: 500;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(107, 142, 232, 0.3);
        }
        
        .form-control {
            border-radius: 10px;
            padding: 12px;
            border: 1px solid #ddd;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(140, 169, 255, 0.25);
        }
        
        /* Main App Styles */
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        #map {
            height: 500px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .member-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }
        
        .member-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.12);
        }
        
        .member-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: 700;
        }
        
        .battery-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .battery-high { background: #d4edda; color: #155724; }
        .battery-medium { background: #fff3cd; color: #856404; }
        .battery-low { background: #f8d7da; color: #721c24; }
        
        .sos-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #dc3545;
            color: white;
            border: none;
            font-size: 24px;
            box-shadow: 0 5px 20px rgba(220, 53, 69, 0.4);
            animation: pulse 2s infinite;
            z-index: 1000;
            cursor: pointer;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .activity-item {
            padding: 15px;
            border-left: 3px solid var(--primary-color);
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
        }
        
        .chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: white;
            border-radius: 15px;
        }
        
        .chat-message {
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            max-width: 70%;
        }
        
        .chat-message.sent {
            background: var(--primary-color);
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .chat-message.received {
            background: #e9ecef;
            color: #333;
        }
        
        .tab-content {
            padding: 20px 0;
        }
        
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideIn 0.3s;
            max-width: 350px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .privacy-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .form-switch .form-check-input {
            width: 50px;
            height: 25px;
            cursor: pointer;
        }
        
        .form-switch .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .nav-pills .nav-link {
            color: #666;
            border-radius: 10px;
            margin-right: 5px;
            transition: all 0.3s;
        }
        
        .nav-pills .nav-link.active {
            background-color: var(--primary-color);
        }
        
        .nav-pills .nav-link:hover:not(.active) {
            background-color: rgba(140, 169, 255, 0.1);
        }
        
        .location-info {
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            #map {
                height: 350px;
            }
            
            .sos-button {
                width: 60px;
                height: 60px;
                font-size: 20px;
                bottom: 20px;
                right: 20px;
            }
            
            .nav-pills .nav-link {
                font-size: 0.85rem;
                padding: 8px 10px;
            }
            
            .member-avatar {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>

    <!-- Auth Container -->
    <div id="authContainer" class="auth-container">
        <!-- Login Form -->
        <div id="loginForm" class="auth-card">
            <div class="auth-logo">
                <i class="fas fa-map-marked-alt"></i>
                <h2>Life360</h2>
                <p class="text-muted">Keamanan Keluarga Anda</p>
            </div>
            <form id="formLogin">
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="loginEmail" required placeholder="contoh@email.com">
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" id="loginPassword" required placeholder="Minimal 6 karakter">
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="rememberMe">
                    <label class="form-check-label" for="rememberMe">Ingat Saya</label>
                </div>
                <button type="submit" class="btn btn-primary w-100">Masuk</button>
                <p class="text-center mt-3">
                    Belum punya akun? <a href="#" id="showRegister" style="color: var(--primary-color); font-weight: 500;">Daftar</a>
                </p>
            </form>
        </div>

        <!-- Register Form -->
        <div id="registerForm" class="auth-card" style="display: none;">
            <div class="auth-logo">
                <i class="fas fa-map-marked-alt"></i>
                <h2>Daftar Life360</h2>
                <p class="text-muted">Bergabunglah dengan Kami</p>
            </div>
            <form id="formRegister">
                <div class="mb-3">
                    <label class="form-label">Nama Lengkap</label>
                    <input type="text" class="form-control" id="regName" required placeholder="Masukkan nama lengkap">
                </div>
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="regEmail" required placeholder="contoh@email.com">
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" id="regPassword" minlength="6" required placeholder="Minimal 6 karakter">
                    <small class="text-muted">Minimal 6 karakter</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Konfirmasi Password</label>
                    <input type="password" class="form-control" id="regConfirmPassword" required placeholder="Ketik ulang password">
                </div>
                <button type="submit" class="btn btn-primary w-100">Daftar</button>
                <p class="text-center mt-3">
                    Sudah punya akun? <a href="#" id="showLogin" style="color: var(--primary-color); font-weight: 500;">Masuk</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-map-marked-alt"></i> Life360
                </a>
                <div class="d-flex align-items-center">
                    <span class="text-white me-3 d-none d-sm-inline" id="userNameDisplay"></span>
                    <button class="btn btn-light btn-sm" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> <span class="d-none d-sm-inline">Keluar</span>
                    </button>
                </div>
            </div>
        </nav>

        <div class="container-fluid mt-4 px-3">
            <!-- Navigation Tabs -->
            <ul class="nav nav-pills mb-4 flex-nowrap overflow-auto" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="map-tab" data-bs-toggle="pill" data-bs-target="#mapTab" type="button">
                        <i class="fas fa-map"></i> Peta
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="members-tab" data-bs-toggle="pill" data-bs-target="#members" type="button">
                        <i class="fas fa-users"></i> Anggota
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="chat-tab" data-bs-toggle="pill" data-bs-target="#chat" type="button">
                        <i class="fas fa-comments"></i> Chat
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="history-tab" data-bs-toggle="pill" data-bs-target="#history" type="button">
                        <i class="fas fa-history"></i> Riwayat
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="pill" data-bs-target="#settings" type="button">
                        <i class="fas fa-cog"></i> Pengaturan
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Map Tab -->
                <div class="tab-pane fade show active" id="mapTab">
                    <div class="row">
                        <div class="col-12">
                            <div class="location-info">
                                <small><i class="fas fa-info-circle text-primary"></i> <strong>Lokasi Anda:</strong> <span id="currentLocation">Memuat...</span></small>
                            </div>
                        </div>
                    </div>
                    <div id="map"></div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6 mb-3">
                            <h5>Anggota Online</h5>
                            <div id="onlineMembersList"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h5>Aktivitas Terbaru</h5>
                            <div id="recentActivities"></div>
                        </div>
                    </div>
                </div>

                <!-- Members Tab -->
                <div class="tab-pane fade" id="members">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Anggota Lingkaran</h4>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#inviteModal">
                            <i class="fas fa-user-plus"></i> Undang
                        </button>
                    </div>
                    <div id="membersList"></div>
                </div>

                <!-- Chat Tab -->
                <div class="tab-pane fade" id="chat">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <h5>Kontak</h5>
                            <div id="chatContactList"></div>
                        </div>
                        <div class="col-md-8">
                            <h5 id="chatHeader">Pilih kontak untuk memulai chat</h5>
                            <div class="chat-container" id="chatMessages"></div>
                            <div class="input-group mt-3">
                                <input type="text" class="form-control" id="chatInput" placeholder="Ketik pesan...">
                                <button class="btn btn-primary" id="sendMessage">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div class="tab-pane fade" id="history">
                    <h4>Riwayat Perjalanan</h4>
                    <div class="mb-3">
                        <label class="form-label">Pilih Anggota</label>
                        <select class="form-select" id="historyMemberSelect">
                            <option value="">Semua Anggota</option>
                        </select>
                    </div>
                    <div id="historyList"></div>
                </div>

                <!-- Settings Tab -->
                <div class="tab-pane fade" id="settings">
                    <h4>Pengaturan Privasi</h4>
                    <div class="privacy-toggle">
                        <div>
                            <strong>Bagikan Lokasi Saya</strong>
                            <div><small class="text-muted">Izinkan anggota melihat lokasi real-time Anda</small></div>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="shareLocationToggle" checked>
                        </div>
                    </div>
                    <div class="privacy-toggle">
                        <div>
                            <strong>Tampilkan Status Baterai</strong>
                            <div><small class="text-muted">Bagikan informasi baterai perangkat Anda</small></div>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="shareBatteryToggle" checked>
                        </div>
                    </div>
                    <div class="privacy-toggle">
                        <div>
                            <strong>Notifikasi Pergerakan</strong>
                            <div><small class="text-muted">Terima notifikasi saat anggota bergerak</small></div>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="movementNotifToggle" checked>
                        </div>
                    </div>
                    
                    <h4 class="mt-4">Laporan Aktivitas</h4>
                    <button class="btn btn-primary mb-3" id="generateReport">
                        <i class="fas fa-file-download"></i> Unduh Laporan Mingguan
                    </button>
                    <div id="activityReport" class="bg-white p-3 rounded"></div>
                </div>
            </div>
        </div>

        <!-- SOS Button -->
        <button class="sos-button" id="sosButton" title="Tombol Darurat">
            <i class="fas fa-exclamation-triangle"></i>
        </button>
    </div>

    <!-- Invite Modal -->
    <div class="modal fade" id="inviteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Undang Anggota Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="inviteForm">
                        <div class="mb-3">
                            <label class="form-label">Nama</label>
                            <input type="text" class="form-control" id="inviteName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email/Telepon</label>
                            <input type="text" class="form-control" id="inviteContact" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Hubungan</label>
                            <select class="form-select" id="inviteRelation">
                                <option value="Keluarga">Keluarga</option>
                                <option value="Pasangan">Pasangan</option>
                                <option value="Teman">Teman</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Kirim Undangan</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Simple encryption (not secure, for demo only)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(36);
        }

        // Authentication System
        class AuthSystem {
            constructor() {
                this.users = JSON.parse(localStorage.getItem('life360_users')) || [];
                this.currentUser = null;
                this.checkSession();
            }

            register(name, email, password) {
                if (this.users.find(u => u.email === email)) {
                    return { success: false, message: 'Email sudah terdaftar' };
                }
                
                const user = {
                    id: Date.now(),
                    name,
                    email,
                    password: simpleHash(password),
                    createdAt: new Date().toISOString()
                };
                
                this.users.push(user);
                localStorage.setItem('life360_users', JSON.stringify(this.users));
                return { success: true, message: 'Registrasi berhasil' };
            }

            login(email, password, remember) {
                const user = this.users.find(u => u.email === email && u.password === simpleHash(password));
                
                if (!user) {
                    return { success: false, message: 'Email atau password salah' };
                }
                
                this.currentUser = user;
                const sessionData = { userId: user.id, remember };
                localStorage.setItem('life360_session', JSON.stringify(sessionData));
                
                return { success: true, user };
            }

            logout() {
                this.currentUser = null;
                localStorage.removeItem('life360_session');
                location.reload();
            }

            checkSession() {
                const session = JSON.parse(localStorage.getItem('life360_session'));
                if (session) {
                    const user = this.users.find(u => u.id === session.userId);
                    if (user) {
                        this.currentUser = user;
                        return true;
                    }
                }
                return false;
            }

            isLoggedIn() {
                return this.currentUser !== null;
            }
        }

        const auth = new AuthSystem();

        // Google Maps Integration
        let map;
        let markers = {};
        let userLocation = { lat: -6.9175, lng: 107.6191 }; // Default: Bandung

        function initMap() {
            // Try to get user's actual location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        createMap();
                        updateLocationName(userLocation);
                    },
                    (error) => {
                        console.log('Geolocation error:', error);
                        createMap();
                    }
                );
            } else {
                createMap();
            }
        }

        function createMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: userLocation,
                zoom: 13,
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });

            // Add user marker
            addMarker('user', userLocation, auth.currentUser.name, '#8CA9FF', 100);

            // Add other members
            members.forEach(m => {
                if (m.id !== 'user') {
                    const pos = generateNearbyLocation(userLocation);
                    addMarker(m.id, pos, m.name, m.color, m.battery);
                }
            });
        }

        function generateNearbyLocation(center) {
            const offset = 0.02; // ~2km
            return {
                lat: center.lat + (Math.random() - 0.5) * offset,
                lng: center.lng + (Math.random() - 0.5) * offset
            };
        }

        function addMarker(id, position, name, color, battery) {
            const batteryIcon = battery > 60 ? 'üîã' : battery > 30 ? 'ü™´' : '‚ö†Ô∏è';
            
            const marker = new google.maps.Marker({
                position: position,
                map: map,
                title: name,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 15,
                    fillColor: color,
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 3
                }
            });

            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="font-family: 'Roboto Slab', serif; padding: 10px;">
                        <h6 style="margin: 0; color: ${color};">${name}</h6>
                        <p style="margin: 5px 0; font-size: 14px;">${batteryIcon} Baterai: ${battery}%</p>
                        <small style="color: #666;">Update: Baru saja</small>
                    </div>
                `
            });

            marker.addListener('click', () => {
                Object.values(markers).forEach(m => m.infoWindow.close());
                infoWindow.open(map, marker);
            });

            markers[id] = { marker, infoWindow };
        }

        function updateLocationName(coords) {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ location: coords }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const address = results[0].formatted_address;
                    document.getElementById('currentLocation').textContent = address;
                } else {
                    document.getElementById('currentLocation').textContent = `${coords.lat.toFixed(4)}, ${coords.lng.toFixed(4)}`;
                }
            });
        }

        // Members Data
        let members = [
            { id: 1, name: 'Ayah', relation: 'Keluarga', battery: 85, color: '#4CAF50', lastUpdate: 'Baru saja' },
            { id: 2, name: 'Ibu', relation: 'Keluarga', battery: 62, color: '#FF9800', lastUpdate: '2 menit lalu' },
            { id: 3, name: 'Adik', relation: 'Keluarga', battery: 30, color: '#E91E63', lastUpdate: '5 menit lalu' }
        ];

        // Initialize App
        function initApp() {
            if (auth.isLoggedIn()) {
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('userNameDisplay').textContent = auth.currentUser.name;
                
                // Add user to members
                members.push({ 
                    id: 'user', 
                    name: auth.currentUser.name, 
                    relation: 'Diri Sendiri', 
                    battery: 75, 
                    color: '#8CA9FF', 
                    lastUpdate: 'Aktif' 
                });
                
                renderMembers();
                renderOnlineMembers();
                renderActivities();
                renderChatContacts();
                renderHistory();
                updateHistorySelect();
                
                // Load Google Maps
                if (!window.google) {
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap`;
                    script.async = true;
                    script.defer = true;
                    document.head.appendChild(script);
                } else {
                    initMap();
                }
            } else {
                document.getElementById('authContainer').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        }

        // Auth Forms
        document.getElementById('formLogin').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const remember = document.getElementById('rememberMe').checked;
            
            const result = auth.login(email, password, remember);
            if (result.success) {
                initApp();
            } else {
                alert(result.message);
            }
        });

        document.getElementById('formRegister').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            
            if (password !== confirmPassword) {
                alert('Password tidak cocok');
                return;
            }
            
            const result = auth.register(name, email, password);
            if (result.success) {
                alert('Registrasi berhasil! Silakan login.');
                document.getElementById('showLogin').click();
            } else {
                alert(result.message);
            }
        });

        document.getElementById('showRegister').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        });

        document.getElementById('showLogin').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('Yakin ingin keluar?')) {
                auth.logout();
            }
        });

        // Render Members
        function renderMembers() {
            const list = document.getElementById('membersList');
            list.innerHTML = members.map(m => `
                <div class="member-card">
                    <div class="d-flex align-items-center">
                        <div class="member-avatar" style="background-color: ${m.color}">
                            ${m.name.charAt(0)}
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">${m.name}</h6>
                            <small class="text-muted">${m.relation}</small>
                        </div>
                        <div class="text-end">
                            <div class="battery-indicator ${m.battery > 60 ? 'battery-high' : m.battery > 30 ? 'battery-medium' : 'battery-low'}">
                                <i class="fas fa-battery-${m.battery > 60 ? 'full' : m.battery > 30 ? 'half' : 'quarter'}"></i> ${m.battery}%
                            </div>
                            <small class="text-muted d-block mt-1">${m.lastUpdate}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderOnlineMembers() {
            const list = document.getElementById('onlineMembersList');
            list.innerHTML = members.map(m => `
                <div class="member-card">
                    <div class="d-flex align-items-center">
                        <div class="member-avatar" style="background-color: ${m.color}; width: 40px; height: 40px; font-size: 16px;">
                            ${m.name.charAt(0)}
                        </div>
                        <div class="flex-grow-1 ms-2">
                            <strong>${m.name}</strong>
                            <div><small class="text-muted">${m.lastUpdate}</small></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Activities
        function renderActivities() {
            const activities = [
                { user: 'Ayah', action: 'Tiba di Kantor', time: '5 menit lalu', icon: 'briefcase', color: '#4CAF50' },
                { user: 'Ibu', action: 'Meninggalkan Rumah', time: '15 menit lalu', icon: 'home', color: '#FF9800' },
                { user: 'Adik', action: 'Tiba di Sekolah', time: '1 jam lalu', icon: 'school', color: '#E91E63' }
            ];
            
            const list = document.getElementById('recentActivities');
            list.innerHTML = activities.map(a => `
                <div class="activity-item">
                    <div class="d-flex align-items-center">
                        <div style="width: 35px; height: 35px; border-radius: 50%; background: ${a.color}; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="fas fa-${a.icon}"></i>
                        </div>
                        <div class="ms-3">
                            <strong>${a.user}</strong> <small>${a.action}</small>
                            <div><small class="text-muted">${a.time}</small></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Chat System
        let currentChat = null;
        let chatMessages = {};

        function renderChatContacts() {
            const list = document.getElementById('chatContactList');
            list.innerHTML = members.filter(m => m.id !== 'user').map(m => `
                <div class="member-card" onclick="openChat('${m.id}', '${m.name}')" style="cursor: pointer;">
                    <div class="d-flex align-items-center">
                        <div class="member-avatar" style="background-color: ${m.color}; width: 45px; height: 45px; font-size: 18px;">
                            ${m.name.charAt(0)}
                        </div>
                        <div class="ms-2">
                            <strong>${m.name}</strong>
                            <div><small class="text-muted">${m.relation}</small></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openChat(memberId, memberName) {
            currentChat = memberId;
            document.getElementById('chatHeader').textContent = `Chat dengan ${memberName}`;
            
            if (!chatMessages[memberId]) {
                chatMessages[memberId] = [
                    { type: 'received', text: 'Halo! Apa kabar?', time: '10:30' }
                ];
            }
            
            renderChatMessages();
        }

        function renderChatMessages() {
            if (!currentChat) return;
            
            const container = document.getElementById('chatMessages');
            const messages = chatMessages[currentChat] || [];
            
            container.innerHTML = messages.map(m => `
                <div class="chat-message ${m.type}">
                    ${m.text}
                    <div style="font-size: 0.75rem; opacity: 0.7; margin-top: 5px;">${m.time}</div>
                </div>
            `).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        document.getElementById('sendMessage').addEventListener('click', () => {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (text && currentChat) {
                const now = new Date();
                const time = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
                
                if (!chatMessages[currentChat]) {
                    chatMessages[currentChat] = [];
                }
                
                chatMessages[currentChat].push({
                    type: 'sent',
                    text: text,
                    time: time
                });
                
                input.value = '';
                renderChatMessages();
                
                setTimeout(() => {
                    chatMessages[currentChat].push({
                        type: 'received',
                        text: 'Baik, terima kasih!',
                        time: time
                    });
                    renderChatMessages();
                }, 2000);
            }
        });

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('sendMessage').click();
            }
        });

        // History
        function renderHistory() {
            const history = [
                { user: 'Ayah', location: 'Kantor', address: 'Jl. Sudirman No. 123', time: '08:30', date: 'Hari ini' },
                { user: 'Ibu', location: 'Supermarket', address: 'Jl. Gatot Subroto No. 45', time: '09:15', date: 'Hari ini' },
                { user: 'Adik', location: 'Sekolah', address: 'Jl. Pendidikan No. 78', time: '07:00', date: 'Hari ini' },
                { user: 'Ayah', location: 'Rumah', address: 'Jl. Mawar No. 12', time: '18:45', date: 'Kemarin' }
            ];
            
            const list = document.getElementById('historyList');
            list.innerHTML = history.map(h => `
                <div class="activity-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${h.user}</strong> - ${h.location}
                            <div><small class="text-muted">${h.address}</small></div>
                        </div>
                        <div class="text-end">
                            <small>${h.date}</small>
                            <div><small class="text-muted">${h.time}</small></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateHistorySelect() {
            const select = document.getElementById('historyMemberSelect');
            select.innerHTML = '<option value="">Semua Anggota</option>' +
                members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        }

        // SOS Button
        document.getElementById('sosButton').addEventListener('click', () => {
            if (confirm('‚ö†Ô∏è PERINGATAN!\n\nAnda akan mengirim sinyal darurat SOS ke semua anggota.\n\nLanjutkan?')) {
                showNotification('üö® <strong>SOS TERKIRIM!</strong><br>Notifikasi darurat telah dikirim ke semua anggota.', 'danger');
                
                setTimeout(() => {
                    alert('üì± Semua anggota telah menerima notifikasi SOS Anda!');
                }, 1000);
            }
        });

        // Invite Member
        document.getElementById('inviteForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('inviteName').value;
            const contact = document.getElementById('inviteContact').value;
            const relation = document.getElementById('inviteRelation').value;
            
            const colors = ['#2196F3', '#9C27B0', '#00BCD4', '#CDDC39'];
            const newMember = {
                id: members.length + 1,
                name: name,
                relation: relation,
                battery: Math.floor(Math.random() * 40) + 60,
                color: colors[Math.floor(Math.random() * colors.length)],
                lastUpdate: 'Baru saja'
            };
            
            members.push(newMember);
            
            if (map) {
                const pos = generateNearbyLocation(userLocation);
                addMarker(newMember.id, pos, newMember.name, newMember.color, newMember.battery);
            }
            
            renderMembers();
            renderOnlineMembers();
            renderChatContacts();
            updateHistorySelect();
            
            showNotification(`‚úâÔ∏è Undangan berhasil dikirim ke <strong>${name}</strong>!`, 'success');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('inviteModal'));
            modal.hide();
            document.getElementById('inviteForm').reset();
        });

        // Generate Report
        document.getElementById('generateReport').addEventListener('click', () => {
            const report = `
                <h5>üìä Laporan Aktivitas Mingguan</h5>
                <p><strong>Periode:</strong> 11 - 18 Desember 2024</p>
                <hr>
                <div class="mb-3">
                    <strong>Total Perjalanan:</strong> 147 kali<br>
                    <strong>Jarak Tempuh:</strong> 423 km<br>
                    <strong>Lokasi Paling Sering:</strong> Kantor (42%), Rumah (35%), Mall (12%)
                </div>
                <div class="mb-3">
                    <strong>Anggota Paling Aktif:</strong><br>
                    1. ${members[0]?.name || 'User'} - 58 perjalanan<br>
                    2. ${members[1]?.name || 'User'} - 45 perjalanan<br>
                    3. ${members[2]?.name || 'User'} - 44 perjalanan
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Rata-rata waktu perjalanan: 23 menit
                </div>
            `;
            
            document.getElementById('activityReport').innerHTML = report;
            showNotification('üìÑ Laporan aktivitas berhasil dibuat!', 'success');
        });

        // Notification System
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div class="d-flex align-items-start">
                    <i class="fas fa-${type === 'danger' ? 'exclamation-circle text-danger' : type === 'success' ? 'check-circle text-success' : 'info-circle text-primary'} me-2"></i>
                    <div>${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // Privacy Settings
        document.getElementById('shareLocationToggle').addEventListener('change', (e) => {
            const status = e.target.checked ? 'diaktifkan' : 'dinonaktifkan';
            showNotification(`Berbagi lokasi telah ${status}`);
        });

        document.getElementById('shareBatteryToggle').addEventListener('change', (e) => {
            const status = e.target.checked ? 'diaktifkan' : 'dinonaktifkan';
            showNotification(`Tampilan status baterai telah ${status}`);
        });

        document.getElementById('movementNotifToggle').addEventListener('change', (e) => {
            const status = e.target.checked ? 'diaktifkan' : 'dinonaktifkan';
            showNotification(`Notifikasi pergerakan telah ${status}`);
        });

        // Initialize on page load
        initApp();
    </script>
</body>
</html>